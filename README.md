# Current Kali configuration

It is interesting to see how a pentester configures their own OS, shells, terminals, shortcuts, and each one of their applications. Every single detail improves the work and result. 

Here are my key OS and tool configurations that help reduce spending my time on enumerations and attacks, being as productive and efficient as possible. 

- Kali
- Tmux
- Fish, plus bash/zsh 

## Kali environment at login

      uname -a	
      Linux kali 5.14.0-kali4-amd64 #1 SMP Debian 5.14.16-1kali1 (2021-11-05) x86_64 GNU/Linux  

      lsb_release -a
      No LSB modules are available.
      Distributor ID: Kali
      Description:    Kali GNU/Linux Rolling
      Release:        2021.4
      Codename:       kali-rolling

      echo $SHELL
      /bin/bash
My approach is a minimal style - "install small and configure small" but rich features to proceed the pentesting. I would love flexible/customizable tools working in terminals, but they should provide rich features out of the box. NOT much configurations to make it work. For my entire kali setup, I install a handful number of applications in hours and configure them within a half day to get started. All of required configuration files are pulled from Github. 


## Tmux screen 

Currently, my tmux screen is based on fish shell with tide UI configured. 
![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux.jpg)

## Shell environment for Pentest 
I switch to fish shell. The fish-tmux combination makes my life easy, especially with super-fast command selection capabilities including syntax highlighting, autosuggestion and autocompletion out of the box. It also work with peco nicely.  

     sudo apt install fish 

Other important setups include: 
1.   Plug in Manager - Fisher https://github.com/jorgebucaran/fisher
2.   Font - Hack              https://github.com/jorgebucaran/fisher
3.   Terminal UI - tide       https://github.com/IlanCosman/tide  
4.   Jump around - z          https://github.com/jethrokuan/z
5.   peco                     https://github.com/peco/peco
![](https://github.com/kiwatana/PentestEnvironment/blob/main/peco.gif)

I am tired of typing long lines of commands, commands, and commands...checking notes, syntaxes, and man pages,etc. You often pause typing a command if you are not sure about options, and move to another pane to check a correct syntax and come back to the original pane. This is a pain in the beginning, and really a brain muscle exercise. I want to stop it. We should look for a better way of searching, checking, and correcting syntaxes, hopefully without modifying commands and without moving around panes, terminals, and applications. I use the fish's syntax highlighting, autosuggestion and tab completion with peco's incremental search that helps me select the best option and run it. In theory and practice, the more you work and own boxes, the more you get past-working commands and the faster. 

## Environment variables for Pentest

Environment variables becomes one of key configurations on modern pentesting. I utilize S1REN's practice on maintaining environment variables within a list of attack/enumeration commands. Check her videos such as https://www.youtube.com/watch?v=RjvPc8OmjSE&t=2517s 

I set environment variables such as URL, LHOST, RHOST, PRROJECT, and SCREENSHOT. These are not global environments, but local environment to a tmux session. I use one tmux session (one terminal) for a single box. If I need to tackle another box, I will open another terminal and run the tmux for the session.   

When you run tmux, a command like below would be your friend.

     tmux new -s 10.x.x.x -e RHOST=10.x.x.x -e LHOST=192.168.x.x -e PROJECT=/home/xxxxxx/xxxxx/lab/YourProject

The environment variables will be kept for the current tmux session. As long as you run the session, the variables are only effective to the session. 

Once you set up environment variables, you run attack commands like

     nmap -sC -sV -o nmap/init $RHOST

This nmap command is never modified in your terminal, just select it from my attack library. If required, the value of the environment variables is updated for another machine in a different tmux session. Use a fish autosuggestion, hit your tab & return keys to run. 

# Tmux configuration

Currently I have two small improvements over normal tmux configurations. Small improvements lead to big productivity difference. 

## Copy & paste without exiting copy-mode

Currently, my tmux config defines the following key binds:
  
	• Prefix and C+u -> Remain copy mode but enable to copy and paste
	• Prefix and C+y -> Exit copy mode and enable to copy and paste (tmux-yank plugin is enabled) 

Here is the actual configuration in .tmux.conf: 

     bind -n C-y source-file ~/.tmux.conf \; display-message "Reload exit-copy-mode while copying!!"     
     bind -n C-u run-shell "~/.tmux_copy.sh" \; display-message "Load remain-copy-mode while copying!!"  

An external shell - .tmux_copy.sh is executed to remain copy mode. The shell has the following codes. 

     tmux set-option mouse on
     tmux bind-key -Tcopy-mode-vi MouseDragEnd1Pane send-key -X copy-pipe "xsel -i -b"
     tmux bind-key -Tcopy-mode-vi Y send -X copy-pipe "xsel -i -b"

xsel works for system clipboard setting in my Kali environment.

![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux_copy.gif)


## Left status bar for my IP address, VPN addresses, and target machine's address

I currently set the eth0, tun0, and tun1 addresses, and the target machine IP address on the left status bar in the tmux. It is nice to see the IP addresses when you set a reverse shell. 

    set -g status-left-length 100
    set -g status-left-style default
    set -g status-left "#h #( $HOME/.tmux/left_status.sh )"

also check left_status.sh script that shows these ip addresses.

![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux_left_status_bar.png)


# Screenshot 

Screenshot is an interesting challenge in pentesting practice. An effective screenshot increases your credibility on reporting & often it is a requirement. However, it is quite normal that you forgot taking a screenshot and need to go back to previous steps for screenshot. This is another muscle memory exercise to build your practice on your own way. There is no great solution for it. 

I am preparing two different ways of taking screenshots. 

1) Manual screenshot when needed 
2) Automatic screenshot for every single command. 

## Manual screenshot  

As usual, set up application shortcuts for region to select and for full screen. Currently, I set up the following configuration on Kali. 

Go to Settings->Keyborad->Application Shortcut

     'flameshot flameshot full -c -p  PathtoDirectory' Ctr+Backslash
     'flameshot gui' Ctr+]

Most of time, use 'flameshot gui' shortcut to select the region, copy it to clipboard, and then paste it to OneNote or other notes. 

## Auto screenshot  

I propose something else here that a shell will take a screenshot instead of you. The shell invokes post execution command for every single command you type in a terminal. There is a lots of areas that do not work such as another applications (browser, Burp, etc.) and a remote terminal environment that you have compromised. This technique also increases the size of the hard desk and it may be taking time to find a right picture of your command. However, you might think that this is a backup technique to have your screenshots just in case you forgot and need to come back, like your are recording all of the commands. 

The following fish config will invoke commands after every single command in .config/fish/config.bash.  

     function my_postexec --on-event fish_postexec
          echo ""
          echo "command completed: $argv[1] ($status)"
          if set -q SCREENSHOT
               if set -q PROJECT
                    flameshot screen -p $PROJECT/screenshots/
               else
                    flameshot screen -p $HOME/Pictures/
               end
          end
     end

You will need to set up a SCREENSHOT environment variable to control this execution. Check fish.config for the configuration.

### Five different ways of enabling and disabling screenshots
<p>
<p>
<i>This may cause some negative impacts when a process is already run such as brute-forcing or revere-shelling. Please ensure you test them and evaluate the risk you are making before taking this approach. </i>

There are 5 different ways to control this automatic screenshot. 

1) Add the environment to tmux command when launching it
2) Run a command for a current pane
3) Run a command for all panes in current window in current session 
4) Run a command for all panes in all windows in current session
5) Run a command for all panes in all windows in all sessions 


### 1) Add the environment to tmux command when launching it

     tmux new -s 10.x.x.x -e RHOST=10.x.x.x -e LHOST=192.168.x.x -e PROJECT=/home/ xxxxxx/xxxxx/lab/YourProject -e SCREENSHOT=YES

### 2) Run a command for a current pane

Run these commands in your terminal in current pane to enable and disable the auto screenshot:  

     set SCREENSHOT YES  # Enable screenshot  or
     set -e SCREENSHOT   # Disable screenshot

### 3) Run a command for all panes in current window in current session 

Type the tmux keybinding below and run commands in terminal: 

     Prefix Alt+[  #synchronize-panes on 
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot
     Prefix Alt+[  #synchronize-panes off  

Check .tmux.config for keybinding configuration. 

### 4) Run a command for all panes in all windows in current session 

Type the tmux keybinding below and run a command in terminal: 

     Prefix Alt+]  #Open a command prompt in tmux  
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot

Check .tmux.config for keybinding configuration. 

### 5) Run a command for all panes in all windows in all sessions 

Type tmux keybinding and run a command in terminal: 

     Prefix Alt+/  #Open command prompt in tmux  
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot

Check .tmux.config for keybinding configuration. 



