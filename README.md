# Current Pentest configuration

It is interesting to see how a pentester configures their own OS, shells, terminals, shortcuts, and each one of their applications. Every single detail improves the work and result. 

Here are my key OS and tool configurations that help reduce spending my time on enumerations and attacks, being as productive and efficient as possible. 

- Kali
- Tmux
- Fish, plus bash/zsh 

## Kali environment at login

      uname -a	
      Linux kali 5.14.0-kali4-amd64 #1 SMP Debian 5.14.16-1kali1 (2021-11-05) x86_64 GNU/Linux  

      lsb_release -a
      No LSB modules are available.
      Distributor ID: Kali
      Description:    Kali GNU/Linux Rolling
      Release:        2021.4
      Codename:       kali-rolling

      echo $SHELL
      /bin/bash
My approach is a minimal style - "install small and configure small" but I want rich features to proceed the pentesting at the same time. Basically, I want the rich features out of the box. NOT much custom configurations to make it work (even though we can). For my entire kali setup, I install a handful number of applications in hours and configure them within a half day to get started. All of required configuration files are pulled from Github. 

## Tmux screen 

Currently, my tmux screen is based on fish shell with tide UI configured. 
![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux.jpg)

## Fish Shell environment for Pentest 
I switched to fish shell, because of the benefits I get. The fish-tmux combination makes my life easy, especially with super-fast command selection capabilities including syntax highlighting, autosuggestion and autocompletion out of the box. It also work with peco/fzf fuzzy search nicely. 

     Fish shell: https://fishshell.com/

When you learn something new (especially for a series of commands to break in), your biggest hurdle would be to repeat faster the practices you learned to different occasions, fail faster, adjust faster, to get newer knowledge into your library, and then repeat it again. Unfortunately, there is no such tool that automatically help you do that. I strongly believe that it would be really important to establish a clever way of searching and selecting commands that you need, hopefully without moving around panes, terminals, and applications. To make it happen, I am exploring the fish shell's syntax highlighting, autosuggestion and tab completion with tmux terminal & fuzzy search search. In practice, the more you own boxes, the more you get past-working-command history. With a common set of attack library, you could run, fail, and adust faster. Here are two great resources for attack library. 

     https://github.com/swisskyrepo/PayloadsAllTheThings
     https://book.hacktricks.xyz/

Warning: stty raw -echo does not work in fish shell as far as I research as of 2022/03/23/. You will need to run bash as a subshell and then run nc command. If you do not like, the fish may not be good to you. Personally, I do not mind typing bash for netcat listener. This is because after you access to your compromised system, you will use the system's environment rather than you kali environment. (Or we may hack fish to make stty raw -echo to work.) 

To install the fish, run the following command.

     sudo apt install fish 

Other important setups include: 
1.   Plug in Manager - Fisher https://github.com/jorgebucaran/fisher
2.   Font - Hack              https://github.com/ryanoasis/nerd-fonts
3.   Terminal UI - tide       https://github.com/IlanCosman/tide  
4.   Jump around - z          https://github.com/jethrokuan/z
5.   peco                     https://github.com/peco/peco
![](https://github.com/kiwatana/PentestEnvironment/blob/main/peco.gif)

If you are vim based developer in linux environment, these are almost de-fact applications to work in terminal. 

## Environment variables for Pentest

Environment variables becomes one of key configurations in a better pentesting practice. I utilize S1REN's practice on maintaining environment variables within a list of attack/enumeration commands. Check her videos such as https://www.youtube.com/watch?v=RjvPc8OmjSE&t=2517s 

I set environment variables such as URL, LHOST, RHOST, PRROJECT, and SCREENSHOT. These are not global environments, but local environment to a tmux session. I use one tmux session (one terminal) for a single box. If I need to tackle another box, I will open another terminal and run the tmux for the session.   

When you run tmux, a command like below would be your friend.

     tmux new -s 10.x.x.x -e RHOST=10.x.x.x -e LHOST=192.168.x.x -e PROJECT=/home/xxxxxx/xxxxx/lab/YourProject

The environment variables will be kept for the current tmux session. As long as you run the session, the variables are only effective to the session. 

Once you set up environment variables, you run enumeration and attack commands like

     nmap -sC -sV -oA nmap/init $RHOST

The nmap command is not modified in the terminal. Just select it from current attack library and command history. Only the value of the environment variables is updated for another machine in another tmux session. 

# Tmux configuration

Currently I have two small improvements over normal tmux configurations. Small improvements lead to big productivity difference. 

## Copy & paste without exiting copy-mode

Currently, my tmux config defines the following key binds:
  
	• Prefix and C+u -> Remain copy mode but enable to copy and paste
	• Prefix and C+y -> Exit copy mode and enable to copy and paste (tmux-yank plugin is enabled) 

Here is the actual configuration in .tmux.conf: 

     bind -n C-y source-file ~/.tmux.conf \; display-message "Reload exit-copy-mode while copying!!"     
     bind -n C-u run-shell "~/.tmux_copy.sh" \; display-message "Load remain-copy-mode while copying!!"  

An external shell - .tmux_copy.sh is executed to remain copy mode. The shell has the following codes. 

     tmux set-option mouse on
     tmux bind-key -Tcopy-mode-vi MouseDragEnd1Pane send-key -X copy-pipe "xsel -i -b"
     tmux bind-key -Tcopy-mode-vi Y send -X copy-pipe "xsel -i -b"

xsel works for system clipboard setting in my Kali environment.

![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux_copy.gif)


## Left status bar for my IP address, VPN addresses, and target machine's address

I currently set the eth0, tun0, and tun1 addresses, and the target machine IP address on the left status bar in the tmux. It is nice to see the IP addresses when you set a reverse shell. 

    set -g status-left-length 100
    set -g status-left-style default
    set -g status-left "#h #( $HOME/.tmux/left_status.sh )"

also check left_status.sh script that shows these ip addresses.

![](https://github.com/kiwatana/PentestEnvironment/blob/main/tmux_left_status_bar.png)


# Screenshot 

Screenshot is an interesting challenge in pentesting practice. An effective screenshot increases your credibility on reporting & often it is a requirement. However, it is quite normal that you forgot taking a screenshot and need to go back to previous steps for screenshot. This is another muscle memory exercise to build your practice on your own way. There is no great solution for it. 

I am preparing two different ways of taking screenshots. 

1) Manual screenshot when needed 
2) Tmux logging 
3) Automatic screenshot for every single command. 

## Manual screenshot (picture as needed)

As usual, set up application shortcuts for region to select and for full screen. Currently, I set up the following configuration on Kali. 

Go to Settings->Keyborad->Application Shortcut

     'flameshot flameshot full -c -p  PathtoDirectory' Ctr+Backslash
     'flameshot gui' Ctr+]

Most of time, use 'flameshot gui' shortcut to select the region, copy it to clipboard, and then paste it to OneNote or other notes. 

## Manual screenshot (each tmux pane)

We can set up a key binding to start & stop tmux logging.

     #Watch and log
     bind-key w pipe-pane "cat >>$HOME/#S-#I-#P.log" \; display-message "Start logging to $HOME/#S-#I-#P.log"
     bind-key W pipe-pane \; display-message "Stop logging to $HOME/#S-#I-#P.log"

This will capture a text-based screenshot and when you see it with cat, you still see the color!, even this works when you run linpeas.sh on a target box for example. However, you would need to call every time before you start/exit a tmux pane. Currently, all logs are stored in $HOME directory. 

## Tmux logging plugins

https://github.com/tmux-plugins/tmux-logging 

Everything that's typed and all the output will be saved to a file. Super-handy. I am using this to save complete history of the panes in tmux. You will lose a color but it is sufficient to keep records and picture-based screenshot. 


    Key binding: prefix + alt + shift + p
    File name format: tmux-history-#{session_name}-#{window_index}-#{pane_index}-%Y%m%dT%H%M%S.log
    File path: $HOME (user home dir)
        Example file: tmux-history-my-session-0-1-20140527T165614.log

When you type the key binding in current pane, this will be saved in a format defined under a user home directory. 


If you want to log all commands in tmux sessions in all windows in current session or all windows in all sessions, run the following command in the tmux command panes. The shortcuts are described in the section below. 

     /home/iptracej/.tmux/plugins/tmux-logging/scripts/save_complete_history.sh


## Auto screenshot  

Even experimentally, I would propose something else here that a shell will take a screenshot instead of you. The shell invokes pre and post executions for every single command you type in a terminal. There is a lots of areas that do not work such as hang, trap, or another applications (browser, Burp, etc.). You could consider that this is a backup technique to store your screenshots on top of other techniques I explain here. 

The following fish config will invoke commands after every single command in .config/fish/config.bash.  

     function my_preexec --on-event fish_preexec
      if set -q SCREENSHOT
       if not string match --quiet -r '^rm|^ls|^cat|^cd' $argv[1]
        if set -q PROJECT
         set path_log $PROJECT/logs
        else
         set path_log $HOME
        end
        tmux pipe-pane -o "cat >> $path_log/tmux_log.#S:#I-#P_tmp.log"
        echo ">" $argv[1]
       end
      end
     end

     function my_postexec --on-event fish_postexec
      if set -q SCREENSHOT
       if not string match --quiet -r '^rm|^ls|^cat|^cd |^set' $argv[1]
        if set -q PROJECT
         set path_log $PROJECT/logs
         set path_pic $PROJECT/screenshots/
        else
         set path_log $HOME
         set path_pic $HOME/Pictures/
        end
        tmux pipe-pane \;
        set val (echo $argv[1] | sed -E "s/[[:punct:]]|[[:space:]]/_/g")
        set date (date +%Y%m%d-%H%M%S)
        set dest $path_log/tmux_log_(date +%Y%m%d-%H%M%S)_(echo $val).log
        mv -f $path_log/tmux_log.*_tmp.log $dest
        #flameshot screen -p $path_pic #Uncomment if you want image screenshot as well
       end
      end
     end

You will need to set up a SCREENSHOT environment variable to control this execution. Check fish.config for the configuration.

### Five different ways of enabling and disabling screenshots
<p>
<p>
<i>This may cause some negative impacts when a process is already run such as brute-forcing or revere-shelling. Please ensure you test them and evaluate the risk you are making before taking this approach. </i>

There are 5 different ways to control this automatic screenshot. If you start enabling the screenshot from your first pane, you do not need to do anything when creating other panes and windows. THe options 3-4 would be for just in case you need to propagate the screenshot setting. 

1) Add the environment to tmux command when launching it
2) Run a command for a current pane
3) Run a command for all panes in current window in current session 
4) Run a command for all panes in all windows in current session
5) Run a command for all panes in all windows in all sessions 


### 1) Add the environment to tmux command when launching it

     tmux new -s 10.x.x.x -e RHOST=10.x.x.x -e LHOST=192.168.x.x -e PROJECT=/home/ xxxxxx/xxxxx/lab/YourProject -e SCREENSHOT=YES

### 2) Run a command for a current pane

Run these commands in your terminal in current pane to enable and disable the auto screenshot:  

     set SCREENSHOT YES  # Enable screenshot  or
     set -e SCREENSHOT   # Disable screenshot

### 3) Run a command for all panes in current window in current session 

Type the tmux keybinding below and run commands in terminal: 

     Prefix Alt+[  #synchronize-panes on 
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot
     Prefix Alt+[  #synchronize-panes off  

Check .tmux.config for keybinding configuration. 

### 4) Run a command for all panes in all windows in current session 

Type the tmux keybinding below and run a command in terminal: 

     Prefix Alt+]  #Open a command prompt in tmux  
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot

Check .tmux.config for keybinding configuration. 

### 5) Run a command for all panes in all windows in all sessions 

Type tmux keybinding and run a command in terminal: 

     Prefix Alt+/  #Open command prompt in tmux  
     set SCREENSHOT YES  # Enable screenshot  or 
     set -e SCREENSHOT   # Disable screenshot

Check .tmux.config for keybinding configuration. 



